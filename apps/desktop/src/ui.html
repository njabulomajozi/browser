<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browser MVP</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #f0f0f0;
        }

        /* Tab Bar */
        .tab-bar {
            display: flex;
            background: #e0e0e0;
            padding: 4px 4px 0 4px;
            gap: 2px;
        }

        .tab {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #d0d0d0;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            max-width: 200px;
            min-width: 100px;
        }

        .tab.active {
            background: white;
        }

        .tab-title {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 13px;
        }

        .tab-close {
            cursor: pointer;
            color: #666;
            font-size: 16px;
            line-height: 1;
        }

        .tab-close:hover {
            color: #000;
        }

        .tab-new {
            padding: 8px 12px;
            background: #d0d0d0;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
        }

        .tab-new:hover {
            background: #c0c0c0;
        }

        /* Navigation Bar */
        .nav-bar {
            display: flex;
            gap: 8px;
            padding: 8px;
            background: white;
            border-bottom: 1px solid #ccc;
        }

        button {
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 14px;
        }

        button:hover {
            background: #f5f5f5;
        }

        button:active {
            background: #e0e0e0;
        }

        #url-input {
            flex: 1;
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        #url-input:focus {
            outline: none;
            border-color: #0066cc;
        }

        /* Content Area */
        .content {
            flex: 1;
            background: white;
            position: relative;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Loading Indicator */
        .loading {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #0066cc;
            animation: loading 1.5s infinite;
        }

        .loading.active {
            display: block;
        }

        @keyframes loading {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
    </style>
</head>
<body>
    <!-- Tab Bar -->
    <div class="tab-bar">
        <div class="tab active" data-tab-id="0">
            <span class="tab-title">New Tab</span>
            <span class="tab-close" onclick="closeTab(0)">×</span>
        </div>
        <div class="tab-new" onclick="createTab()">+</div>
    </div>

    <!-- Navigation Bar -->
    <div class="nav-bar">
        <button onclick="goBack()">←</button>
        <button onclick="goForward()">→</button>
        <button onclick="reload()">⟳</button>
        <input
            type="text"
            id="url-input"
            placeholder="Enter URL or search..."
            value="https://example.com"
            onkeypress="handleUrlKeypress(event)"
        />
        <button onclick="navigate()">Go</button>
    </div>

    <!-- Content Area -->
    <div class="content">
        <div class="loading" id="loading"></div>
        <iframe
            id="content-frame"
            sandbox="allow-same-origin allow-scripts allow-forms allow-popups"
        ></iframe>
    </div>

    <script>
        // Browser state
        let state = {
            tabs: [
                { id: 0, title: 'Example Domain', url: 'https://example.com' }
            ],
            activeTab: 0
        };

        // Normalize URL for comparison (handles trailing slashes, etc.)
        function normalizeUrl(url) {
            try {
                const urlObj = new URL(url);
                return urlObj.href;
            } catch {
                return url;
            }
        }

        // Update UI from state
        function updateUI() {
            // Update tab bar
            const tabBar = document.querySelector('.tab-bar');
            const tabs = state.tabs.map((tab, index) => `
                <div class="tab ${index === state.activeTab ? 'active' : ''}"
                     data-tab-id="${tab.id}"
                     onclick="switchTab(${index})">
                    <span class="tab-title">${tab.title}</span>
                    ${state.tabs.length > 1 ? `<span class="tab-close" onclick="event.stopPropagation(); closeTab(${index})">×</span>` : ''}
                </div>
            `).join('');
            tabBar.innerHTML = tabs + '<div class="tab-new" onclick="createTab()">+</div>';

            // Update URL bar
            const activeTab = state.tabs[state.activeTab];
            if (activeTab) {
                document.getElementById('url-input').value = activeTab.url;

                // Update iframe if URL changed (use normalized comparison)
                const iframe = document.getElementById('content-frame');
                const currentSrc = normalizeUrl(iframe.src || '');
                const targetUrl = normalizeUrl(activeTab.url);

                console.log('[UPDATE] Comparing URLs - current:', currentSrc, 'target:', targetUrl);

                if (currentSrc !== targetUrl) {
                    console.log('[UPDATE] URLs differ, loading new URL');
                    showLoading();
                    iframe.src = activeTab.url;
                } else {
                    console.log('[UPDATE] URLs match, skipping load');
                }
            }
        }

        // Navigation functions
        function navigate() {
            const url = document.getElementById('url-input').value;
            let fullUrl = url;

            // Add protocol if missing
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                // Check if it's a search query or URL
                if (url.includes(' ') || !url.includes('.')) {
                    // Search query
                    fullUrl = 'https://www.google.com/search?q=' + encodeURIComponent(url);
                } else {
                    // Assume URL
                    fullUrl = 'https://' + url;
                }
            }

            state.tabs[state.activeTab].url = fullUrl;
            updateUI();
        }

        function goBack() {
            const iframe = document.getElementById('content-frame');
            if (iframe.contentWindow) {
                iframe.contentWindow.history.back();
            }
        }

        function goForward() {
            const iframe = document.getElementById('content-frame');
            if (iframe.contentWindow) {
                iframe.contentWindow.history.forward();
            }
        }

        function reload() {
            showLoading();
            const iframe = document.getElementById('content-frame');
            iframe.src = iframe.src; // Force reload
        }

        function handleUrlKeypress(event) {
            if (event.key === 'Enter') {
                navigate();
            }
        }

        // Tab management
        function createTab() {
            const newTab = {
                id: Date.now(),
                title: 'New Tab',
                url: 'https://example.com'
            };
            state.tabs.push(newTab);
            state.activeTab = state.tabs.length - 1;
            updateUI();
        }

        function closeTab(index) {
            if (state.tabs.length === 1) return; // Keep at least one tab

            state.tabs.splice(index, 1);
            if (state.activeTab >= state.tabs.length) {
                state.activeTab = state.tabs.length - 1;
            }
            updateUI();
        }

        function switchTab(index) {
            state.activeTab = index;
            updateUI();
        }

        // Loading indicator with timeout fallback
        let loadingTimeout = null;

        function showLoading() {
            console.log('[LOADING] showLoading() called');
            const loadingEl = document.getElementById('loading');
            loadingEl.classList.add('active');
            console.log('[LOADING] Spinner shown, classes:', loadingEl.className);

            // Clear any existing timeout
            if (loadingTimeout) {
                clearTimeout(loadingTimeout);
            }

            // Auto-hide after 10 seconds (fallback for failed loads)
            loadingTimeout = setTimeout(() => {
                console.warn('[LOADING] TIMEOUT - hiding spinner after 10s');
                hideLoading();
            }, 10000);
        }

        function hideLoading() {
            console.log('[LOADING] hideLoading() called');
            const loadingEl = document.getElementById('loading');
            loadingEl.classList.remove('active');
            console.log('[LOADING] Spinner hidden, classes:', loadingEl.className);

            // Clear timeout
            if (loadingTimeout) {
                clearTimeout(loadingTimeout);
                loadingTimeout = null;
            }
        }

        // iframe load events
        const iframe = document.getElementById('content-frame');

        console.log('[INIT] Attaching iframe event listeners');

        iframe.addEventListener('load', () => {
            console.log('[IFRAME] load event fired, src:', iframe.src);
            hideLoading();

            // Try to update tab title from iframe
            try {
                const title = iframe.contentDocument.title;
                console.log('[IFRAME] Got title:', title);
                if (title) {
                    state.tabs[state.activeTab].title = title;
                    // Update only tab bar, NOT full updateUI() to prevent loop
                    const tabBar = document.querySelector('.tab-bar');
                    const tabs = state.tabs.map((tab, index) => `
                        <div class="tab ${index === state.activeTab ? 'active' : ''}"
                             data-tab-id="${tab.id}"
                             onclick="switchTab(${index})">
                            <span class="tab-title">${tab.title}</span>
                            ${state.tabs.length > 1 ? `<span class="tab-close" onclick="event.stopPropagation(); closeTab(${index})">×</span>` : ''}
                        </div>
                    `).join('');
                    tabBar.innerHTML = tabs + '<div class="tab-new" onclick="createTab()">+</div>';
                }
            } catch (e) {
                // Cross-origin, can't access title - use URL as title
                console.warn('[IFRAME] Cross-origin, cannot access title:', e.message);
                state.tabs[state.activeTab].title = state.tabs[state.activeTab].url;
                // Update only tab bar
                const tabBar = document.querySelector('.tab-bar');
                const tabs = state.tabs.map((tab, index) => `
                    <div class="tab ${index === state.activeTab ? 'active' : ''}"
                         data-tab-id="${tab.id}"
                         onclick="switchTab(${index})">
                        <span class="tab-title">${tab.title}</span>
                        ${state.tabs.length > 1 ? `<span class="tab-close" onclick="event.stopPropagation(); closeTab(${index})">×</span>` : ''}
                    </div>
                `).join('');
                tabBar.innerHTML = tabs + '<div class="tab-new" onclick="createTab()">+</div>';
            }
        });

        // Handle iframe load errors
        iframe.addEventListener('error', (e) => {
            console.error('[IFRAME] error event fired:', e);
            hideLoading();
        });

        // Initial setup: attach listeners first, then load initial page
        // This ensures load/error events are caught
        console.log('[INIT] Calling updateUI() to load initial page');
        updateUI();  // This will trigger the initial page load with spinner
    </script>
</body>
</html>
